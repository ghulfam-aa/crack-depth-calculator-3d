<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crack Depth Calculator (3D) - PULSONIC</title>
    <!-- Font Awesome (Optional, but included in previous code) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #3498db; --primary-dark: #2980b9; --secondary-color: #e0f2fe;
            --text-dark: #2c3e50; --text-light: #5a6878; --border-color: #cbd5e0;
            --background-light: #ffffff; --background-gradient-start: #eaf0f7; --background-gradient-end: #d8e2ec;
            --success-bg: #e0f2fe; --success-border: #a0cff5; --success-icon: #3498db;
            --error-bg: #feefec; --error-border: #f5a0a4; --error-icon: #e74c3c;
            --diagram-concrete: #e2e8f0; --diagram-transducer: #374151;
            --diagram-crack: #e74c3c; --diagram-label: #4b5563;
        }
         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
         body { background: linear-gradient(135deg, var(--background-gradient-start), var(--background-gradient-end)); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; font-size: 16px; color: var(--text-dark); }
        .container { background: var(--background-light); border-radius: 15px; box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15); padding: 40px; width: 100%; max-width: 500px; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid #e2e8f0; }
        .container:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(44, 62, 80, 0.2); }
        h1 { text-align: center; color: var(--text-dark); margin-bottom: 35px; font-size: 26px; font-weight: 600; letter-spacing: 0.5px; }
        h1 i { margin-right: 10px; color: var(--primary-color); }
        .input-group { margin-bottom: 25px; }
        label { display: block; color: var(--text-light); font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        input[type="number"] { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease, box-shadow 0.3s ease; appearance: textfield; -moz-appearance: textfield; }
        input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        button { width: 100%; padding: 14px; background: linear-gradient(180deg, var(--primary-color), var(--primary-dark)); border: none; border-radius: 8px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease; box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08); }
        button:hover { background: linear-gradient(180deg, #4fa8e0, #318fd6); box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08); }
        button:active { transform: translateY(1px); }
        #result { margin-top: 30px; font-size: 16px; padding: 15px 20px; border-radius: 8px; display: flex; align-items: center; justify-content: flex-start; min-height: 58px; width: 100%; line-height: 1.5; word-wrap: break-word; transition: background-color 0.3s ease, border-color 0.3s ease; background-color: var(--success-bg); border: 1px solid var(--success-border); color: var(--text-dark); }
        #result i { font-size: 20px; margin-right: 12px; color: var(--success-icon); flex-shrink: 0; }
        #result.error { background-color: var(--error-bg); border-color: var(--error-border); color: #a54844; }
        #result.error i { color: var(--error-icon); }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: var(--text-light); }

        /* --- 3D Diagram Styles --- */
        #diagramSection { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); display: none; position: relative; }
        #diagramSection h2 { font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 15px; text-align: center; }
        #diagramCanvas { display: block; width: 100% !important; max-width: 400px; height: 250px !important; margin: 0 auto; background-color: #f8fafd; border-radius: 5px; cursor: grab; }
        #diagramCanvas:active { cursor: grabbing; }
        .diagram-label-3d { position: absolute; font-size: 10px; font-weight: 500; color: var(--diagram-label); background-color: rgba(255, 255, 255, 0.85); padding: 2px 4px; border-radius: 3px; white-space: nowrap; text-align: center; pointer-events: none; transform: translateX(-50%); display: none; }

        @media (max-width: 480px) {
            #diagramCanvas { height: 200px !important; }
            .diagram-label-3d { font-size: 9px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-ruler-combined"></i>Crack Depth Calculator (3D)</h1>
        <!-- MAKE SURE THE FORM ID IS CORRECT -->
        <form id="crackForm">
             <div class="input-group"><label for="t1">Transit Time in Sound Concrete (t1, µs):</label><input type="number" id="t1" step="any" min="0.00001" required placeholder="e.g., 25"></div>
             <div class="input-group"><label for="l1">Sound Concrete Spacing (L1, mm):</label><input type="number" id="l1" step="any" min="0.00001" required placeholder="e.g., 100"></div>
             <div class="input-group"><label for="t2">Transit Time Across Crack (t2, µs):</label><input type="number" id="t2" step="any" min="0.00001" required placeholder="e.g., 70.7"></div>
             <div class="input-group"><label for="l2">Cracked Concrete Spacing (L2, mm):</label><input type="number" id="l2" step="any" min="0.00001" required placeholder="e.g., 200"></div>
             <button type="submit">Calculate Crack Depth</button>
        </form>

        <div id="result"><i class="fas fa-info-circle"></i><span>Result will appear here</span></div>

        <!-- 3D Diagram Section -->
        <div id="diagramSection">
            <h2>3D Schematic View</h2>
            <canvas id="diagramCanvas"></canvas>
            <span id="label-l2-start" class="diagram-label-3d">0 mm</span>
            <span id="label-l2-end" class="diagram-label-3d">L2 = ? mm</span>
            <span id="label-h-value" class="diagram-label-3d">h = ? mm</span>
        </div>

        <div class="footer">Powered by PULSONIC | Based on BS EN 12504-4:2004 | 3D View powered by Three.js</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.161.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls;
        let concreteBlock, crackPlane, transducerLeft, transducerRight;
        let labelL2Start, labelL2End, labelHValue;
        let diagramSection, diagramCanvas;
        const VISUAL_WIDTH_SCALE = 5; const VISUAL_DEPTH_SCALE = 3; const CRACK_PLANE_WIDTH = 0.1;

        function initThreeJS() {
            diagramCanvas = document.getElementById('diagramCanvas');
            if (!diagramCanvas) { console.error("Canvas element not found!"); return; }
            labelL2Start = document.getElementById('label-l2-start'); labelL2End = document.getElementById('label-l2-end'); labelHValue = document.getElementById('label-h-value');
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f4f8);
            const aspectRatio = diagramCanvas.clientWidth / diagramCanvas.clientHeight;
            camera = new THREE.PerspectiveCamera(50, aspectRatio, 0.1, 100); camera.position.set(0, 3, 8); camera.lookAt(0, 0, 0);
            renderer = new THREE.WebGLRenderer({ canvas: diagramCanvas, antialias: true }); renderer.setSize(diagramCanvas.clientWidth, diagramCanvas.clientHeight); renderer.setPixelRatio(window.devicePixelRatio);
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8); directionalLight.position.set(5, 10, 7.5); scene.add(directionalLight);
            controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.1; controls.screenSpacePanning = false; controls.target.set(0, 0, 0);
            createInitialObjects();
            animate();
            window.addEventListener('resize', onWindowResize, false);
        }

        function createInitialObjects() {
            const blockGeometry = new THREE.BoxGeometry(VISUAL_WIDTH_SCALE * 1.2, VISUAL_DEPTH_SCALE, VISUAL_DEPTH_SCALE * 0.8);
            const blockMaterial = new THREE.MeshStandardMaterial({ color: 0xd1d5db, roughness: 0.8 });
            concreteBlock = new THREE.Mesh(blockGeometry, blockMaterial); concreteBlock.position.y = -VISUAL_DEPTH_SCALE / 2; scene.add(concreteBlock);
            const transducerRadius = 0.15; const transducerHeight = 0.1; const transducerGeometry = new THREE.CylinderGeometry(transducerRadius, transducerRadius, transducerHeight, 16);
            const transducerMaterial = new THREE.MeshStandardMaterial({ color: 0x374151, roughness: 0.5 });
            transducerLeft = new THREE.Mesh(transducerGeometry, transducerMaterial); transducerLeft.position.set(-VISUAL_WIDTH_SCALE / 2, transducerHeight / 2, 0); scene.add(transducerLeft);
            transducerRight = new THREE.Mesh(transducerGeometry, transducerMaterial); transducerRight.position.set(VISUAL_WIDTH_SCALE / 2, transducerHeight / 2, 0); scene.add(transducerRight);
            const crackGeometry = new THREE.PlaneGeometry(CRACK_PLANE_WIDTH, 0.01);
            const crackMaterial = new THREE.MeshBasicMaterial({ color: 0xef4444, side: THREE.DoubleSide, transparent: true, opacity: 0.8 });
            crackPlane = new THREE.Mesh(crackGeometry, crackMaterial); crackPlane.position.set(0, -0.005, 0); scene.add(crackPlane);
        }

        function updateDiagram3D(l2, h) {
            const visualL2 = VISUAL_WIDTH_SCALE; transducerLeft.position.x = -visualL2 / 2; transducerRight.position.x = visualL2 / 2;
            const maxExpectedH = l2; const visualMaxH = VISUAL_DEPTH_SCALE * 0.9; const h_scaled = (h / maxExpectedH) * visualMaxH;
            const finalVisualH = Math.min(Math.max(h_scaled, 0.01), visualMaxH);
            crackPlane.scale.y = finalVisualH / 0.01; crackPlane.position.y = - (finalVisualH / 2);
            updateOverlayLabels(l2, h);
        }

        function updateOverlayLabels(l2, h) {
             if (!renderer || !camera || !labelL2Start || !labelL2End || !labelHValue) return;
             const canvas = renderer.domElement;
             const toScreenPosition = (object) => {
                 const vector = new THREE.Vector3(); object.getWorldPosition(vector); vector.project(camera);
                 const x = ((vector.x * 0.5 + 0.5) * canvas.clientWidth); const y = ((-vector.y * 0.5 + 0.5) * canvas.clientHeight); return { x, y };
             };
             const posL2Start = toScreenPosition(transducerLeft); const posL2End = toScreenPosition(transducerRight);
             const crackTopPos = new THREE.Vector3(crackPlane.position.x, 0, crackPlane.position.z); const posH = toScreenPosition({ getWorldPosition: (v) => v.copy(crackTopPos) });
             labelL2Start.style.display = 'block'; labelL2Start.style.left = `${posL2Start.x}px`; labelL2Start.style.top = `${posL2Start.y - 20}px`;
             labelL2End.style.display = 'block'; labelL2End.textContent = `${l2.toFixed(0)} mm`; labelL2End.style.left = `${posL2End.x}px`; labelL2End.style.top = `${posL2End.y - 20}px`;
             labelHValue.style.display = 'block'; labelHValue.textContent = `h = ${h.toFixed(2)} mm`; labelHValue.style.left = `${posH.x + 20}px`; labelHValue.style.top = `${posH.y + (VISUAL_DEPTH_SCALE * 15)}px`;
         }

        function onWindowResize() {
            if (!camera || !renderer || !diagramCanvas) return;
            camera.aspect = diagramCanvas.clientWidth / diagramCanvas.clientHeight; camera.updateProjectionMatrix();
            renderer.setSize(diagramCanvas.clientWidth, diagramCanvas.clientHeight);
        }

        function animate() { requestAnimationFrame(animate); if (controls) controls.update(); if (renderer && scene && camera) renderer.render(scene, camera); }

        // --- Main Execution Logic ---
        // This runs after HTML is parsed because script is type="module" (deferred)
        console.log("Script module execution started."); // DEBUG LOG

        diagramSection = document.getElementById('diagramSection');
        const form = document.getElementById('crackForm');

        // Verify form element is found
        if (!form) {
            console.error("CRITICAL: Form element with ID 'crackForm' not found!");
        } else {
            console.log("Form element found successfully."); // DEBUG LOG
        }

        // Hide diagram initially
        if (diagramSection) {
            diagramSection.style.display = 'none';
            console.log("Diagram section hidden initially."); // DEBUG LOG
        } else {
             console.warn("Diagram section element not found.");
        }

        // Attach listener only if form exists
        if (form) {
            form.addEventListener('submit', function(event) {
                console.log("Submit event triggered."); // DEBUG LOG
                // *** THIS IS THE CRITICAL LINE ***
                event.preventDefault();
                console.log("Default form submission prevented."); // DEBUG LOG
                calculateCrackDepth();
            });
            console.log("Submit event listener attached to form."); // DEBUG LOG
        }

        // Initialize Three.js environment
        try {
            initThreeJS();
            console.log("Three.js initialized successfully."); // DEBUG LOG
        } catch (error) {
            console.error("Error during Three.js initialization:", error);
            showResult("Error initializing 3D view. Check console.", true);
        }

        // Definition of calculateCrackDepth function
        function calculateCrackDepth() {
            console.log("CalculateCrackDepth function called."); // DEBUG LOG
            const t1Input = document.getElementById('t1'); const l1Input = document.getElementById('l1');
            const t2Input = document.getElementById('t2'); const l2Input = document.getElementById('l2');
            const t1 = parseFloat(t1Input.value); const l1 = parseFloat(l1Input.value);
            const t2 = parseFloat(t2Input.value); const l2 = parseFloat(l2Input.value);

            let isValid = true; let errorMsg = "";
            if (isNaN(t1) || isNaN(l1) || isNaN(t2) || isNaN(l2)) { isValid = false; errorMsg = "Error: All inputs must be valid numbers."; }
            else if ( [t1Input.value, l1Input.value, t2Input.value, l2Input.value].some(val => val.trim() === '') ) { isValid = false; errorMsg = "Error: All fields are required."; }
            else if (t1 <= 0 || l1 <= 0 || t2 <= 0 || l2 <= 0) { isValid = false; errorMsg = "Error: All values must be greater than zero."; }
            if (!isValid) { console.log("Validation failed:", errorMsg); showResult(errorMsg, true); return; }

            const velocity = l1 / t1;
            if (!isFinite(velocity) || velocity <= 0) { console.log("Velocity calculation failed."); showResult("Error: Cannot calculate velocity. Check t1 and l1.", true); return; }

            const t1Scaled = l2 / velocity; const a = l2 / 2; const ratio = t2 / t1Scaled;
            if (ratio <= 1 || !isFinite(ratio)) {
                const errorDetail = isFinite(t1Scaled) ? `(t2/t1_scaled ratio: ${ratio.toFixed(3)})` : '(Invalid t1_scaled)';
                console.log("Ratio validation failed."); showResult(`Error: t2 must be > calculated direct time. ${errorDetail}`, true); return;
            }

            const h = a * Math.sqrt(ratio * ratio - 1);
            if (!isFinite(h)) { console.log("Depth calculation failed (NaN/Infinity)."); showResult("Error: Calculation resulted in an invalid depth.", true); return; }

            console.log("Calculation successful. Depth:", h.toFixed(2)); // DEBUG LOG
            showResult(`Crack Depth: ${h.toFixed(2)} mm`, false);
            if (diagramSection) diagramSection.style.display = 'block';
            try {
                 updateDiagram3D(l2, h); // Update 3D view
                 console.log("3D diagram updated."); // DEBUG LOG
            } catch(err) {
                 console.error("Error updating 3D diagram:", err);
                 showResult(`Crack Depth: ${h.toFixed(2)} mm. (Error updating 3D view)`, false); // Show result but note diagram error
            }
        }

        // Definition of showResult function
        function showResult(message, isError = false) {
            console.log(`ShowResult called. Message: "${message}", IsError: ${isError}`); // DEBUG LOG
            const resultDiv = document.getElementById('result');
            const iconElement = resultDiv.querySelector('i');
            const textElement = resultDiv.querySelector('span');
            textElement.textContent = message;

             // Ensure diagramSection is defined before using
             if (!diagramSection) {
                 diagramSection = document.getElementById('diagramSection');
             }
             // Ensure labels are defined
             if (!labelL2Start) labelL2Start = document.getElementById('label-l2-start');
             if (!labelL2End) labelL2End = document.getElementById('label-l2-end');
             if (!labelHValue) labelHValue = document.getElementById('label-h-value');

             if (isError) {
                resultDiv.classList.add('error'); iconElement.className = "fas fa-exclamation-triangle";
                if (diagramSection) diagramSection.style.display = 'none';
                if (labelL2Start) labelL2Start.style.display = 'none';
                if (labelL2End) labelL2End.style.display = 'none';
                if (labelHValue) labelHValue.style.display = 'none';
             } else {
                resultDiv.classList.remove('error'); iconElement.className = "fas fa-check-circle";
                // Diagram shown on success within calculateCrackDepth
             }
        }

        console.log("Script module execution finished."); // DEBUG LOG

    </script>

</body>
</html>
